name: Visual Regression

on:
  pull_request:
    paths:
      - "packages/kumo-docs-astro/src/components/demos/**"
      - "packages/kumo/src/components/**"
      - "packages/kumo/src/styles/**"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: visual-regression-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  visual-regression:
    name: Visual Regression
    if: ${{ github.repository_owner == 'cloudflare' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies
        uses: ./.github/actions/install-dependencies
        with:
          filter: "@cloudflare/kumo-docs-astro..."

      - name: Build @cloudflare/kumo
        run: pnpm --filter @cloudflare/kumo build

      - name: Build docs for PR
        run: pnpm --filter @cloudflare/kumo-docs-astro build

      - name: Deploy PR docs preview
        id: deploy-after
        working-directory: packages/kumo-docs-astro
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          VERSION_OUTPUT=$(pnpm exec wrangler versions upload --env="" --message "Visual regression PR #${{ github.event.pull_request.number }}" 2>&1) || true
          PREVIEW_URL=$(echo "$VERSION_OUTPUT" | grep -oE 'Version Preview URL: https://[^ ]+' | sed 's/Version Preview URL: //')

          if [ -z "$PREVIEW_URL" ]; then
            VERSION_ID=$(echo "$VERSION_OUTPUT" | grep -oE 'Worker Version ID: [a-f0-9-]+' | sed 's/Worker Version ID: //')
            if [ -n "$VERSION_ID" ]; then
              VERSION_PREFIX=$(echo "$VERSION_ID" | cut -c1-8)
              PREVIEW_URL="https://${VERSION_PREFIX}-kumo-docs.design-engineering.workers.dev"
            fi
          fi

          echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"

      - name: Run Visual Regression
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BEFORE_URL: "https://kumo-ui.com"
          AFTER_URL: ${{ steps.deploy-after.outputs.preview_url }}
          SCREENSHOT_WORKER_URL: ${{ secrets.SCREENSHOT_WORKER_URL }}
          SCREENSHOT_API_KEY: ${{ secrets.SCREENSHOT_API_KEY }}
        run: |
          pnpm tsx ci/visual-regression/run-visual-regression.ts

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-regression-screenshots
          path: ci/visual-regression/screenshots/
          retention-days: 7
